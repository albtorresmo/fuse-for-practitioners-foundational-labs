== Use Case 3 - Camel Route publishing the messages into a queue and handling the DLQ messages

The purpose of this use case is to extend/revisit the use case 1 to publish the JSON messages into different queues instead of the folders outbox and error.
For the erroneous messages, you will replace the DLQ folder with a DLQ queue and will develop a strategy to update/correct the erroneous messages
and re inject these messages into the normal flow. A redelivery policy must be put in place to attempt 3 times to redeliver the messages before to place them
on the DLQ and the initialRedeliveryDelay must be off 500ms.

A notification/alert mechanism must be developed to send a message to topic containing the error code and error message.
A Camel JMS client is connected to this topic in order to be informed about the error reported when faulty messages are thrown. The erroneous message and the message code
received will be saved into an error table.

.Goals
* Combine the Routing and Integration technology with a messaging platform
* Develop a project able to use locally Apache ActiveMQ or JBoss A-MQ to publish the messages into different queues
* Use the DLQ pattern supported by Apache ActiveMQ / JBoss A-MQ
* Implement a redelivery strategy with A-MQ
* Notify the durable subscriber client using a topic that erroneous messages have been produced
* Use an idempotentConsumer to avoid to consume multiple times the error redelivered
* Report the error (code and message) within the usecase database (table T_ERROR)
* Report also the error on the console using Log4j, the logging level "DEBUG" and the logger name "org.fuse.usecase"
* Use the Camel SQL component with headers to INSERT the record within the DB.

:numbered:

== Import the Project (TODO - Discuss how we will setup the project)

. In JBoss Developer Studio, switch to the *Git* perspective. 
. Click the icon at the top to clone a Git repository and add the clone to this view.
. In the *URI* text box, copy and paste the following: 
+
------
https://github.com/gpe-mw-training/fuse-for-practitioners-labs.git
------
+
. Switch to *Project Explorer* for the *JBoss* perspective.
. Import a new Maven project by selecting *File -> Import -> Maven -> Existing Maven Projects -> Next*. Import the `core` and it's parent project
. Navigate to the location of the Git projects for the Data Transformation tool and click *Finish*.
. Click the *Project Explorer* tab and expand the `Inbound` project node. 
+  
.Application structure
image::images/application_structure.png[width="40%"]

. Examine the following files and folders that appear in the expanded view:

* `routing`: module in which you will develop the `route`, `unit test` of the use-case.
** `src/main/resources/schema` : JSON and csv schemas files you will need to create the Data Transformation
* `parent` : Contain JBoss Fuse 6.2.1 dependencies, properties definition and maven plugins used by the modules
* `features` : Apache Karaf XML features file to be used to deploy the `usecase` project on JBoss Fuse without Fabric technology

=== Configure H2 Database

* Download [H2 DB](http://www.h2database.com/html/download.html) - Tested with 1.4.190 locally
* Unzip the content and open a terminal
* Launch it `./h2-1.4.190/bin/h2.sh`
* Within your browser `http://localhost:8082/login.jsp`, setup the connection

[source]
----
Driver class : org.h2.Driver
JDBC Url : jdbc:h2:tcp://localhost/~/usecaseDB
User : sa
Password :
----

* Create the DB (if not yet done) using the `routing/src/main/resources/schema/db/usecaseDB.sql` script and run these commands within the browser

[source]
----
DROP SCHEMA USECASE;
CREATE SCHEMA USECASE;
CREATE TABLE USECASE.T_ACCOUNT (
    ID BIGINT GENERATED BY DEFAULT AS IDENTITY(START WITH 1) NOT NULL PRIMARY KEY,
    CLIENT_ID BIGINT,
    SALES_CONTACT VARCHAR(30),
    COMPANY_NAME VARCHAR(50),
    COMPANY_GEO CHAR(20) ,
    COMPANY_ACTIVE BOOLEAN,
    CONTACT_FIRST_NAME VARCHAR(35),
    CONTACT_LAST_NAME VARCHAR(35),
    CONTACT_ADDRESS VARCHAR(255),
    CONTACT_CITY VARCHAR(40),
    CONTACT_STATE VARCHAR(40),
    CONTACT_ZIP VARCHAR(10),
    CONTACT_EMAIL VARCHAR(60),
    CONTACT_PHONE VARCHAR(35),
    CREATION_DATE TIMESTAMP,
    CREATION_USER VARCHAR(255)
);

CREATE TABLE USECASE.T_ERROR (
    ID BIGINT AUTO_INCREMENT NOT NULL PRIMARY KEY,
    ERROR_CODE SMALLINT NOT NULL,
    ERROR_MESSAGE VARCHAR(255),
    MESSAGE VARCHAR(512),
    STATUS CHAR(5)
);
----

=== Build the `routing` Project & test it locally

. On the command line, run the following commands:

[source]
----
mvn clean install
mvn camel:run
----

=== Bonus

Define the features XML file to deploy the project on JBoss Fuse 6.2.1 and test it using these commands to be executed within the Fuse console.

[source]
----
addurl mvn:org.fuse.usecase/features/1.0/xml/features
features:install usecase-dlq-jms
----

Instead of using the features XML file, you can also create a Fabric8 profile by editing the <fabric8.xxxx> xml tags that you have within the pom.xml routing file
and next execute this command to create the profile into JBoss Fuse Fabric

[source]
----
mvn fabric8:deploy
----



