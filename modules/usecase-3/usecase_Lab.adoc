== Use Case 3 - Camel Route publishing the messages into a queue and handling the DLQ messages

The purpose of this use case is to extend/revisit the use case 1 to publish the JSON messages into different queues instead of the folders outbox and error.
For the erroneous messages, you will replace the DLQ folder with a DLQ queue and will develop a strategy to update/correct the erroneous messages
and re inject these messages into the normal flow. A redelivery policy must be put in place to avoid that the client, through the connection factory
, tries to redeliver the erroneous message.

A notification/alert mechanism must be developed to send a message to a topic containing the error code and error message. To be notified that there is an error,
an interception strategy must be defined to check if there is an IllegalArgumentException generated. If this is case, an error code and the exception message will
be added to the message that you will publish on a topic.
A client is connected to this topic in order to be informed about the error reported when a faulty exception is thrown. The erroneous message and the message code
received will be saved into an error table. Each record created will be managed with a status (ERROR, FIXED, CLOSE).
According to the strategy that you have developed to correct the message, you will next resend/republish it to the queue consuming
the input messages in order to process it if the status value is equal to FIXED. The messages consuled from the database will have finally their status updated to the value CLOSE.

.Goals
* Combine the Routing and Integration technology with a messaging platform
* Develop a project able to use locally Apache ActiveMQ or JBoss A-MQ to publish the messages into different queues
* Use the DLQ pattern supported by Apache ActiveMQ / JBoss A-MQ
* Implement a redelivery strategy with Apache ActiveMQ / JBoss A-MQ to disable th redelivery
* Notify the durable subscriber client using a topic that erroneous messages have been produced
* Report the error (code and message) within the usecase database (table T_ERROR)
* Report also the error on the console using Log4j with the logging level "DEBUG" and the logger name "org.fuse.usecase"
* Use the Camel SQL component to INSERT the record within the DB and listen to corrected messages from the table T_ERROR

:numbered:

== Import the Project (TODO - Discuss how we will setup the project)

. In JBoss Developer Studio, switch to the *Git* perspective. 
. Click the icon at the top to clone a Git repository and add the clone to this view.
. In the *URI* text box, copy and paste the following: 
+
------
https://github.com/gpe-mw-training/fuse-for-practitioners-labs.git
------
+
. Switch to *Project Explorer* for the *JBoss* perspective.
. Import a new Maven project by selecting *File -> Import -> Maven -> Existing Maven Projects -> Next*. Import the `core` and it's parent project
. Navigate to the location of the Git projects for the Data Transformation tool and click *Finish*.
. Click the *Project Explorer* tab and expand the `Inbound` project node. 
+  
.Application structure
image::images/application_structure.png[width="40%"]

. Examine the following files and folders that appear in the expanded view:

* `routing`: module in which you will develop the `route`, `unit test` of the use-case.
** `src/main/resources/schema` : JSON and csv schemas files you will need to create the Data Transformation
* `parent` : Contain JBoss Fuse 6.2.1 dependencies, properties definition and maven plugins used by the modules
* `features` : Apache Karaf XML features file to be used to deploy the `usecase` project on JBoss Fuse without Fabric technology

=== Configure H2 Database

* Download [H2 DB](http://www.h2database.com/html/download.html) - Tested with 1.4.190 locally
* Unzip the content and open a terminal
* Launch it `./h2-1.4.190/bin/h2.sh`
* Within your browser `http://localhost:8082/login.jsp`, setup the connection

[source]
----
Driver class : org.h2.Driver
JDBC Url : jdbc:h2:tcp://localhost/~/usecaseDB
User : sa
Password :
----

* Create the DB (if not yet done) using the `routing/src/main/resources/schema/db/usecaseDB.sql` script and run these commands within the browser

[source]
----
DROP SCHEMA IF EXISTS USECASE;

CREATE SCHEMA USECASE;

CREATE TABLE USECASE.T_ACCOUNT (
    ID BIGINT GENERATED BY DEFAULT AS IDENTITY(START WITH 1) NOT NULL PRIMARY KEY,
    CLIENT_ID BIGINT,
    SALES_CONTACT VARCHAR(30),
    COMPANY_NAME VARCHAR(50),
    COMPANY_GEO CHAR(20) ,
    COMPANY_ACTIVE BOOLEAN,
    CONTACT_FIRST_NAME VARCHAR(35),
    CONTACT_LAST_NAME VARCHAR(35),
    CONTACT_ADDRESS VARCHAR(255),
    CONTACT_CITY VARCHAR(40),
    CONTACT_STATE VARCHAR(40),
    CONTACT_ZIP VARCHAR(10),
    CONTACT_EMAIL VARCHAR(60),
    CONTACT_PHONE VARCHAR(35),
    CREATION_DATE TIMESTAMP,
    CREATION_USER VARCHAR(255)
);

CREATE TABLE USECASE.T_ERROR (
    ID BIGINT AUTO_INCREMENT NOT NULL PRIMARY KEY,
    ERROR_CODE SMALLINT NOT NULL,
    ERROR_MESSAGE VARCHAR(255),
    MESSAGE VARCHAR(512),
    STATUS CHAR(5)
);
----

=== Configure the Camel ActiveMQComponent and the connectionFactory

In order to use locally the project, you will create a Spring XML file to setup a Broker. The Broker configuration must include the following paramaters

* SimpleAuthentication Plugin with the user `admin` assigned to the group `users,admins`. the password of the user is `admin`
* Transport Connector defined for the openwire / tcp transport protocol running on port `61616`
* Dead Letter Strategy implemented for the queues and having this prefix `DLQ.`

IMPORTANT: This spring XML file should be located under a different directory, then `META-INF/spring` to avoid that it will be used when deployed on JBoss Fuse as there is a by default Broker
installed

Configure the ActiveMQ Component to use a ConnectionFactory to call the broker on this address `tcp://localhost:61616` for the user `admin`

NOTE: If A JMS Transaction Manager is required, please use the Spring JmsTransactionManager class

WARNING: The Redelivery strategy will be defined using the ActiveMQ RedeliveryPolicy as requested within the usecase

=== Review the existing Camel Routes

As we will start this project from the usecase 1, you will reuse the code crated within this project in order to replace the
file component with the ActiveMQ component and different queues.

Update the keys within the `fabric8/route.properties` file to use the new endpoints

NOTE: Don't hesitate to create Camel Spring Junit Test case to validate the logic of your Camel Routes

=== Implement the interception strategy

Develop your interception strategy to fetch the `IllegalArgumentException` exception and move the information into a topic `usecase-error`
with the information requested into the usecase description `error-code` and `error-message`. The code of the error could be set to `111`
and the error message will correspond to the first message reported by the stack trace that Camel Bindy has throw.

NOTE: The string content of the message must be also saved into the JMS message as it will be used to update the T_ERROR table

TIP: You can create a `direct:error` route that you will call from your interception strategy

TIP : Don't hesitate to add some Log EIP processor to collect information using the Logging Level DEBUG and the logName `org.fuse.usecase`

=== Extend the existing Camel routes

Add a new route with an ActiveMQ endpoint to consume from the topic `usecase-error`, the JMS Messages received.
Develop from this route your strategy insert the a record with the information (code, error message and message, status) within
the table T_ERROR

=== Developp your strategy to inject the corrected message

Based on the information saved into the T_ERROR database, develop your strategy to inject the corrected message into the `usecase-input`
 queue.

WARNING: Don't forget to update the status according to the values defined (a new message haq the status equal to ERROR, when updated to FIXED
 and when it will be reinjected CLOSE)

=== Build the `routing` Project & test it locally

. On the command line, run the following commands

[source]
----
mvn clean install
mvn camel:run
----

. Demonstrate that your logic implemented is correct (records into the DB, messages within the queues, ...)

=== Bonus

Define the features XML file to deploy the project on JBoss Fuse 6.2.1 and test it using these commands to be executed within the Fuse console.

[source]
----
addurl mvn:org.fuse.usecase3/features/1.0/xml/features
features:install usecase-dlq-jms
----

Instead of using the features XML file, you can also create a Fabric8 profile by editing the <fabric8.xxxx> xml tags that you have within the pom.xml routing file
and next execute this command to create the profile into JBoss Fuse Fabric

[source]
----
mvn fabric8:deploy
----

=== Useful SQL scripts

[source]
----
INSERT INTO USECASE.T_ACCOUNT (CLIENT_ID,SALES_CONTACT,COMPANY_NAME,COMPANY_GEO,COMPANY_ACTIVE,CONTACT_FIRST_NAME,CONTACT_LAST_NAME,CONTACT_ADDRESS,CONTACT_CITY,CONTACT_STATE,CONTACT_ZIP,CONTACT_PHONE,CREATION_DATE,CREATION_USER) VALUES ('95','Rachel Cassidy','MountainBikers','SOUTH_AMERICA',true,'George','Jungle','1101 Smith St.','Raleigh','NC','27519','919-555-0800','2015-12-15','fuse_usecase');

DELETE FROM USECASE.T_ACCOUNT;
DELETE FROM USECASE.T_ERROR;

SELECT * FROM USECASE.T_ACCOUNT;
SELECT * FROM USECASE.T_ERROR;

UPDATE USECASE.T_ERROR SET MESSAGE='Error,EU,true,Fred,Quicksand,202 Barney Blvd.,Rock City,MI,19728,313-555-1234', STATUS='FIXED' WHERE ID=8;

DROP SCHEMA USECASE;
----


