# Fuse Use Case 2 Project

## Maven Modules

* parent : Contain dependencies, properties definitions and common maven plugins used by the modules
* routing : Apache Camel routes. Unit test.
* features : Apache Karaf XML features file

## Configure H2 Database

- Download [H2 DB]() - Tested with 1.4.190 locally
- Unzip the content and open a terminal
- Launch it `./h2-1.4.190/bin/h2.sh`
- Within your browser `http://localhost:8082/login.jsp`, setup the connection

```
Driver class : org.h2.Driver
JDBC Url : jdbc:h2:tcp://localhost/~/usecaseDB
User : sa
Password : 
```

- Create the DB using the `routing/src/main/resources/schema/db/usecaseDB.sql` script and run these commands within the browser

```
DROP SCHEMA USECASE;
CREATE SCHEMA USECASE;
CREATE TABLE USECASE.T_ACCOUNT (
    ID BIGINT GENERATED BY DEFAULT AS IDENTITY(START WITH 1) NOT NULL PRIMARY KEY,
    CLIENT_ID BIGINT,
    SALES_CONTACT VARCHAR(30),
    COMPANY_NAME VARCHAR(50),
    COMPANY_GEO CHAR(20) ,
    COMPANY_ACTIVE BOOLEAN,
    CONTACT_FIRST_NAME VARCHAR(35),
    CONTACT_LAST_NAME VARCHAR(35),
    CONTACT_ADDRESS VARCHAR(255),
    CONTACT_CITY VARCHAR(40),
    CONTACT_STATE VARCHAR(40),
    CONTACT_ZIP VARCHAR(10),
    CONTACT_EMAIL VARCHAR(60),
    CONTACT_PHONE VARCHAR(35),
    CREATION_DATE TIMESTAMP,
    CREATION_USER VARCHAR(255)
);
```

## Build project

```
mvn clean install
```

## Deploy it on JBoss Fuse

- Download and Install JBoss Fuse 6.2.1
- Open a terminal and move to the home directory of the distribution
- Launch JBoss Fuse 

```
./bin/fuse
```

- When the Console appears, then deploy the XML features file and install the use case

```
addurl mvn:org.fuse.usecase2/features/1.0/xml/features
features:install usecase-camel-aggregation-db
```

- Copy/paste the `src/data/inbox/customers.csv` file to the `src/data/inbox` folder created under the home directory of the JBoss Fuse server
  and check that 3 files have been created under `src/data/outbox` and one under `src/data/error`
  
- Test the REST Service

```
echo '{"company":{"name":"Rotobots","geo":"NA","active":true},"contact":{"firstName":"Bill","lastName":"Smith","streetAddr":"100 N Park Ave.","city":"Phoenix","state":"AZ","zip":"85017","phone":"602-555-1100"}}' | http -v POST http://localhost:9191/rest/customerservice/enrich
```
  
## Use Fabric
  
- Install Fabric within JBoss Fuse
 
```
fabric:create
```

- Execute this maven command from the `routing` folder 

```
mvn fabric8:deploy
```

- Create a container and deploy the use case profile

```
fabric:container-create-child root usecase1
fabric:container-add-profile usecase1 fuse-usecase1
```

- Copy/paste the `src/data/inbox/customers.csv` file to the `src/data/inbox` folder created under the usecase1 folder of the instance created into the 
  `instances` directory and check that 3 files have been created under `src/data/outbox` and one under `src/data/error`
